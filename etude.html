<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Etude - MIDI Light Player</title>
    <style>
        :root { 
            --accent: #8e9aaf; 
            --panel: #1e1e24; 
            --bg: #121214; 
            --text: #d1d1d1; 
            --gold: #c2a878; 
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body { 
            font-family: 'Georgia', serif; 
            background: var(--bg); 
            color: var(--text); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px;
        }
        
        .rack { 
            background: var(--panel); 
            border: 1px solid #333; 
            border-radius: 4px; 
            width: 900px; 
            padding: 30px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.6); 
            position: relative;
            box-sizing: border-box; 
        }

        .header { 
            border-bottom: 1px solid #444; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: baseline; 
        }

        .logo-container {
            display: flex;
            align-items: baseline;
            gap: 15px;
        }

        .logo { 
            font-weight: normal; 
            font-size: 1.6em; 
            letter-spacing: 6px; 
            color: var(--gold); 
            text-transform: uppercase; 
        }

        .version-tag {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.6em;
            color: #555;
            letter-spacing: 1px;
            border: 1px solid #333;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .param-box { 
            background: rgba(0,0,0,0.2); 
            padding: 20px; 
            border-radius: 2px; 
            margin-bottom: 20px; 
            border: 1px solid rgba(255,255,255,0.05); 
        }

        .controls-row { 
            display: flex; 
            flex-direction: row; 
            gap: 8px; 
            justify-content: center; 
            margin-bottom: 20px; 
            width: 100%;
        }

        .controls-row button { 
            flex: 1; 
            min-width: 45px; 
            font-weight: bold; 
            height: 42px; 
            white-space: nowrap; 
        }
		
		.footer-credit {
			margin-top: 20px;
			font-size: 0.65em;
			text-transform: uppercase;
			letter-spacing: 2px;
			color: #444; 
			text-align: center;
			font-family: 'Georgia', serif;
		}

		.footer-credit span {
			color: var(--gold); 
			font-style: italic;
		}
		
        /* --- KEYBOARD & VIZ --- */
        .keyboard-panel {
            margin-top: 10px;
            background: #080808;
            padding: 20px 0; 
            border-radius: 2px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: visible; 
        }

        .visualizer-container {
            position: relative;
            width: 780px;
            height: 300px;
            background: rgba(0,0,0,0.3);
            margin-bottom: 0;
            overflow: hidden;
            border-bottom: 2px solid #333;
            display: none; 
        }

        #noteCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .piano {
			display: flex;
			position: relative;
			height: 80px; 
			user-select: none;
			width: 780px; 
			margin: 0 auto;
			background: #000;
		}

		.key {
			border: 1px solid #bbb;
			background: linear-gradient(to bottom, #eee 0%, #fff 100%);
			width: 15px; 
			height: 100%;
			box-sizing: border-box;
			border-radius: 0 0 3px 3px;
			flex-shrink: 0;
			position: relative;
		}

		.key.black {
			background: linear-gradient(to bottom, #444 0%, #000 100%);
			width: 9px; 
			height: 60%; 
			margin-left: -4.5px;
			margin-right: -4.5px;
			z-index: 2;
			border: 1px solid #000;
			border-radius: 0 0 2px 2px;
		}

        .key.white.active { 
            background: var(--gold) !important; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2); 
            border-color: #fff;
            z-index: 1;
        }

        .key.black.active { 
            background: rgba(160, 135, 90, 0.9) !important; 
            box-shadow: inset 0 0 12px rgba(0,0,0,0.6); 
            border-color: #8a734a;
            z-index: 3;
        }
		
		.header-right-tools {
			display: flex;
			align-items: center;
			gap: 20px;
		}
		
		.mini-kbd {
			display: flex;
			height: 35px; 
			background: #000;
			padding: 2px;
			border-radius: 2px;
			border: 1px solid #444;
			box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
		}
		
		.m-key {
			width: 12px; 
			height: 100%;
			background: #bbb;
			margin: 0 1px;
			border-radius: 0 0 2px 2px;
			transition: var(--transition);
		}
		
		.m-key.b {
			background: #222;
			height: 65%;
			width: 8px; 
			margin-left: -5px; 
			margin-right: -5px;
			z-index: 2;
			border: 1px solid #000;
		}
		
		.mini-kbd:hover .m-key {
			background: #eee;
			border-color: var(--gold);
		}
	
		.mini-kbd:hover .m-key.b {
			background: #333;
		}	
	
        details summary { list-style: none; cursor: pointer; font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; color: var(--gold); display: flex; justify-content: space-between; }
        .static-header { font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; color: var(--gold); display: block; margin-bottom: 15px; }
        
        button { 
            background: #2a2a30; 
            border: 1px solid #444; 
            color: #aaa; 
            padding: 10px; 
            border-radius: 2px; 
            cursor: pointer; 
            font-size: 0.75em; 
            text-transform: uppercase; 
            font-family: 'Georgia', serif; 
            transition: var(--transition); 
        }
        
        button:hover { background: #35353d; border-color: var(--gold); color: #fff; }
        
        button.active { 
            border-color: var(--gold); 
            color: var(--gold); 
            box-shadow: inset 0 0 5px rgba(194, 168, 120, 0.2);
        }

        #btnToggleViz {
            flex: 0.5 !important;
            max-width: 100px;
            display: none;
        }

        button svg { fill: currentColor; width: 18px; height: 18px; }
        label { font-size: 0.7em; text-transform: uppercase; color: #888; margin-bottom: 10px; display: block; }
        .val { float: right; color: var(--gold); font-style: italic; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: #121214; height: 3px; margin: 15px 0; }
        
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            height: 24px; 
            width: 24px; 
            background: var(--gold); 
            border-radius: 50%; 
            cursor: pointer; 
            border: 2px solid var(--panel);
            background-position: center;
            background-repeat: no-repeat;
            background-size: 60%;
        }

        #playbar::-webkit-slider-thumb {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231e1e24'%3E%3Cpath d='M8 5v14l11-7z'/%3E%3C/svg%3E");
        }

        #volume::-webkit-slider-thumb {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231e1e24'%3E%3Cpath d='M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z'/%3E%3C/svg%3E");
        }

        #volume.is-muted::-webkit-slider-thumb {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231e1e24'%3E%3Cpath d='M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z'/%3E%3C/svg%3E");
        }

        select { background: #121214; color: var(--text); border: 1px solid #444; width: 100%; padding: 10px; }
        .divider { border: 0; border-top: 1px solid #333; margin: 20px 0; }
        .console { margin-top: 30px; font-size: 0.75em; color: #555; text-align: center; }
        .speed-indicator, .timer-indicator { font-size: 0.85em; color: var(--gold); font-weight: bold; }
        .pulse { width: 10px; height: 10px; background: #444; border-radius: 2px; }
        .pulse.active { background: var(--gold); box-shadow: 0 0 10px var(--gold); }
        #midiFile { display: none; }
        .color-strip { width: 50px; height: 35px; border: 1px solid #444; cursor: pointer; background: none; }
    </style>
</head>
<body>

<div class="rack">

	<div class="header">
        <div class="logo-container">
            <div class="logo">É T U D E</div>
            <div class="version-tag">v1.0</div>
        </div>
        <div class="header-right-tools">
            <div class="mini-kbd">
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div>
            </div>
            <div id="midiPulse" class="pulse"></div>
        </div>
	</div>
	
    <details id="performanceDeck" class="param-box" ontoggle="checkDeckState()">
        <summary>Performance Deck <span>▼</span></summary>
        <div class="keyboard-panel">
            <div id="vizContainer" class="visualizer-container">
                <canvas id="noteCanvas" width="780" height="300"></canvas>
            </div>
            <div id="piano" class="piano"></div>
        </div>
    </details>

    <div class="param-box">
        <span class="static-header">Main Controls</span>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input type="file" id="midiFile" accept=".mid,.midi" onchange="parseMidiFile(event)">
            <button onclick="document.getElementById('midiFile').click()" style="flex: 3;" id="fileNameDisplay">Load MIDI File</button>
            <button id="btnToggleViz" onclick="toggleVisualizer()">Notes Off</button>
        </div>

        <div class="controls-row">
            <button id="btnLearn" onclick="toggleLearningMode()" title="Learning Mode">
                <svg viewBox="0 0 24 24"><path d="M12 3L1 9L12 15L21 10.09V17H23V9M5 13.18V17.18L12 21L19 17.18V13.18L12 17L5 13.18Z"/></svg>
            </button>
            <button onclick="seek(0)">⏮</button>
            <button onclick="skip(-10000)">-10 s</button>
            <button class="btn-skip" onclick="changeSpeed(-0.25)">-1/4 x</button>
            <button id="btnPlay" onclick="startPlayback()" style="color: #a3be8c;">▶</button>
            <button id="btnPause" onclick="pausePlayback()" style="color: #ebcb8b;">⏸</button>
            <button class="btn-skip" onclick="changeSpeed(0.25)">+1/4 x</button>
            <button onclick="skip(10000)">+10 s</button>
            <button onclick="seek(totalDuration)">⏭</button>
        </div>

        <div style="margin-top: 25px;">
            <input type="range" id="playbar" min="0" max="100" value="0" oninput="seek(this.value)">
            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                <span class="speed-indicator" id="speedVal" onclick="resetSpeed()" style="cursor:pointer">1.00x</span>
                <span class="timer-indicator" id="timeLabel">0:00 / 0:00</span>
            </div>
        </div>
        <hr class="divider">
        <div>
            <label>Accent <span class="val" id="volVal">50%</span></label>
            <input type="range" id="volume" min="0" max="100" value="50" oninput="updateUI()">
        </div>
    </div>

    <details class="param-box">
        <summary>System Configuration <span>▼</span></summary>
        <div style="margin-top: 20px;">
            <label>Hardware Connectivity</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                <button id="btnSerial" onclick="connectSerial()">Initialize Lighting</button>
                <button id="btnMidi" onclick="connectMidi()">Scan MIDI Devices</button>
            </div>
            <label>Midi Destination <span class="val" id="pianoStatus">Offline</span></label>
            <select id="midiOutSelect" style="margin-bottom: 20px;"><option value="">Select Output Device...</option></select>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <label>Octave <span class="val" id="octaveVal">0</span></label>
                    <input type="range" id="octaveShift" min="-4" max="4" value="0" oninput="updateUI()">
                </div>
                <div>
                    <label>Transpose <span class="val" id="transVal">0</span></label>
                    <input type="range" id="transpose" min="-12" max="12" value="0" oninput="updateUI()">
                </div>
            </div>
            <hr class="divider">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <label>Light Intensity <span class="val" id="brightVal">5%</span></label>
                    <input type="range" id="brightness" min="0" max="100" value="5" oninput="updateUI()">
                </div>
                <div>
                    <label>Master Tint</label>
                    <div style="display:flex; gap:10px; align-items: center;">
						<div style="flex: 1;">
							<label style="margin-bottom: 5px;">White Key LED</label>
							<input type="color" id="whiteKeyColor" class="color-strip" value="#e5c68a" style="width: 100%;" oninput="updateUI()">
						</div>
						<div style="flex: 1;">
							<label style="margin-bottom: 5px;">Black Key LED</label>
							<input type="color" id="blackKeyColor" class="color-strip" value="#917846" style="width: 100%;" oninput="updateUI()">
						</div>
						<button id="btnRainbow" onclick="toggleRainbow()" style="height: 35px; align-self: flex-end;">Rainbow</button>
					</div>
                </div>
            </div>
        </div>
    </details>

    <div class="console" id="consoleOut">System Ready.</div>
	<div class="footer-credit">Powered by <span>CORMAL</span></div> 	
</div>

<script>
let port, writer, rainbow = false, isPlaying = false, midiOutput = null;
let midiEvents = [], nextEventIndex = 0, totalDuration = 0, currentTimeOffset = 0, startTime = 0;
let playbackRate = 1.0, learningMode = false, currentTargetNotes = [];
let playTimer;
let notePairs = [];
const canvas = document.getElementById('noteCanvas');
const ctx = canvas.getContext('2d');
const noteSpeed = 0.15;

const log = (m) => { document.getElementById('consoleOut').innerText = m; };

function checkDeckState() {
    const deck = document.getElementById('performanceDeck');
    const btn = document.getElementById('btnToggleViz');
    btn.style.display = deck.open ? 'block' : 'none';
}

function toggleVisualizer() {
    const container = document.getElementById('vizContainer');
    const btn = document.getElementById('btnToggleViz');
    const isHidden = window.getComputedStyle(container).display === 'none';
    if (isHidden) {
        container.style.display = 'block';
        btn.innerText = 'Notes On';
        btn.classList.add('active');
    } else {
        container.style.display = 'none';
        btn.innerText = 'Notes Off';
        btn.classList.remove('active');
    }
}

function buildKeyboard() {
    const piano = document.getElementById('piano');
    const pattern = [0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0];
    for (let i = 21; i <= 108; i++) {
        const key = document.createElement('div');
        const isBlack = pattern[i % 12] === 1;
        key.className = `key ${isBlack ? 'black' : 'white'}`;
        key.id = `vkey-${i}`;
        piano.appendChild(key);
    }
}

function renderFallingNotes() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const whiteKeyNoteColor = "#e5c68a"; 
    const blackKeyNoteColor = "#917846"; 
    const blackKeyPattern = [0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0];
    
    notePairs.forEach(note => {
        const timeToStart = note.start - currentTimeOffset;
        const duration = note.end - note.start;
        const yBottom = canvas.height - (timeToStart * noteSpeed);
        const yTop = yBottom - (duration * noteSpeed);
        
        if (yBottom > 0 && yTop < canvas.height) {
            const keyEl = document.getElementById(`vkey-${note.note}`);
            if (keyEl) {
                const isBlackKey = blackKeyPattern[note.note % 12] === 1;
                const noteColor = isBlackKey ? blackKeyNoteColor : whiteKeyNoteColor;
                const originalW = keyEl.offsetWidth;
                const w = originalW * 0.5; 
                const xOffset = (originalW - w) / 2;
                const x = keyEl.offsetLeft + xOffset;
                const h = yBottom - yTop;
                const radius = 6; 

                ctx.save(); 
                ctx.shadowColor = noteColor; 
                ctx.shadowBlur = 15;
                ctx.fillStyle = noteColor;
                ctx.globalAlpha = 0.9; 
                ctx.beginPath();
                ctx.roundRect(x, yTop, w, h, radius);
                ctx.fill();
                ctx.shadowBlur = 0; 
                ctx.globalAlpha = 1.0;
                ctx.strokeStyle = "rgba(255,255,255,0.3)";
                ctx.lineWidth = 1;
                ctx.stroke();
                ctx.restore();
            }
        }
    });
    requestAnimationFrame(renderFallingNotes);
}

function visualizeNote(data) {
    let [status, note, velocity] = data;
    const isNoteOn = (status & 0xf0) === 0x90 && velocity > 0;
    const vKey = document.getElementById(`vkey-${note}`);
    
    if (vKey) {
        if (isNoteOn) vKey.classList.add('active');
        else vKey.classList.remove('active');
    }

    if (!writer) return;
    const index = (note + (parseInt(document.getElementById('octaveShift').value) * 12) + parseInt(document.getElementById('transpose').value) - 21) * 2;

    if (index >= 0 && index < 288) {
        if (isNoteOn) {
            const blackKeyPattern = [0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0];
            const isBlackKey = blackKeyPattern[note % 12] === 1;
            const hex = isBlackKey ? 
                document.getElementById('blackKeyColor').value : 
                document.getElementById('whiteKeyColor').value;

            let r = parseInt(hex.substring(1,3), 16);
            let g = parseInt(hex.substring(3,5), 16);
            let b = parseInt(hex.substring(5,7), 16);
            if (rainbow) [r, g, b] = hslToRgb((note % 12) / 12, 1, 0.5);
            const bright = parseInt(document.getElementById('brightness').value);
            writer.write(new TextEncoder().encode(`${index},${r},${g},${b},${bright}\n`));
        } else {
            writer.write(new TextEncoder().encode(`${index},0,0,0,0\n`));
        }
    }
}

async function connectSerial() { try { port = await navigator.serial.requestPort(); await port.open({ baudRate: 115200 }); writer = port.writable.getWriter(); document.getElementById('btnSerial').classList.add('active'); log("Lighting Online."); } catch (e) { log("Serial failed."); } }
async function connectMidi() { try { const access = await navigator.requestMIDIAccess(); const select = document.getElementById('midiOutSelect'); select.innerHTML = '<option value="">Select Output Device...</option>'; for (let output of access.outputs.values()) { let opt = document.createElement('option'); opt.value = output.id; opt.innerText = output.name; select.appendChild(opt); } select.onchange = () => { midiOutput = access.outputs.get(select.value); document.getElementById('pianoStatus').innerText = midiOutput ? "Linked" : "Offline"; }; for (let input of access.inputs.values()) { input.onmidimessage = handleIncomingMidi; } document.getElementById('btnMidi').classList.add('active'); } catch (e) { log("MIDI failed."); } }
function handleIncomingMidi(message) { if (!learningMode) return; const [status, note, velocity] = message.data; if ((status & 0xf0) === 0x90 && velocity > 0) { const idx = currentTargetNotes.indexOf(note); if (idx !== -1) { currentTargetNotes.splice(idx, 1); if (currentTargetNotes.length === 0) advanceLearningStep(); } } }
function toggleLearningMode() { learningMode = !learningMode; document.getElementById('btnLearn').classList.toggle('active', learningMode); if (learningMode) { isPlaying = false; prepareNextLearningStep(); } else { hush(); log("Standard Mode."); } }
function prepareNextLearningStep() { if (!learningMode || nextEventIndex >= midiEvents.length) return; currentTargetNotes = []; hush(); let nextNoteEvent = midiEvents.slice(nextEventIndex).find(ev => (ev.data[0] & 0xf0) === 0x90 && ev.data[2] > 0); if (!nextNoteEvent) return; const targetTime = nextNoteEvent.time; nextEventIndex = midiEvents.findIndex(ev => ev.time === targetTime); let lookAhead = nextEventIndex; while (lookAhead < midiEvents.length && Math.abs(midiEvents[lookAhead].time - targetTime) < 50) { const ev = midiEvents[lookAhead]; if ((ev.data[0] & 0xf0) === 0x90 && ev.data[2] > 0) { currentTargetNotes.push(ev.data[1]); visualizeNote(ev.data); } lookAhead++; } currentTimeOffset = targetTime; document.getElementById('playbar').value = currentTimeOffset; updateTimeLabel(currentTimeOffset); }
function advanceLearningStep() { const targetTime = midiEvents[nextEventIndex].time; while (nextEventIndex < midiEvents.length && Math.abs(midiEvents[nextEventIndex].time - targetTime) < 50) nextEventIndex++; prepareNextLearningStep(); }
function startPlayback() { if (midiEvents.length === 0) return; if (learningMode) toggleLearningMode(); isPlaying = true; document.getElementById('btnPlay').classList.add('active'); document.getElementById('btnPause').classList.remove('active'); startTime = performance.now() - (currentTimeOffset / playbackRate); playLoop(); }
function pausePlayback() { isPlaying = false; cancelAnimationFrame(playTimer); hush(); document.getElementById('btnPlay').classList.remove('active'); document.getElementById('btnPause').classList.add('active'); }
function playLoop() { if (!isPlaying) return; currentTimeOffset = (performance.now() - startTime) * playbackRate; while (nextEventIndex < midiEvents.length && midiEvents[nextEventIndex].time <= currentTimeOffset) { handleMidi(midiEvents[nextEventIndex].data); nextEventIndex++; } document.getElementById('playbar').value = currentTimeOffset; updateTimeLabel(currentTimeOffset); if (currentTimeOffset >= totalDuration) pausePlayback(); else playTimer = requestAnimationFrame(playLoop); }
function handleMidi(data) {
    let [status, note, velocity] = data;
    let forcedStatus = (status & 0xF0) | 0x00; 
    if (midiOutput) {
        let vol = parseInt(document.getElementById('volume').value) / 100;
        let finalVelocity = Math.round(velocity * vol);
        midiOutput.send([forcedStatus, note, finalVelocity]);
    }
    visualizeNote(data);
}
async function hush() { if (midiOutput) { for (let n = 0; n < 127; n++) midiOutput.send([0x80, n, 0]); } if (writer) { try { await writer.write(new TextEncoder().encode("R\n")); } catch(e){} } const keys = document.querySelectorAll('.key'); keys.forEach(k => k.classList.remove('active')); }
async function parseMidiFile(e) { const file = e.target.files[0]; if (!file) return; document.getElementById('fileNameDisplay').innerText = file.name; const buffer = await file.arrayBuffer(); const data = new Uint8Array(buffer); midiEvents = []; nextEventIndex = 0; let pos = 0, tempoMap = [{ tick: 0, ms: 0, tempo: 500000 }]; const readStr = (len) => String.fromCharCode(...data.slice(pos, pos += len)); const read32 = () => (data[pos++] << 24) | (data[pos++] << 16) | (data[pos++] << 8) | data[pos++]; const read16 = () => (data[pos++] << 8) | data[pos++]; const readVar = () => { let v = 0; while (true) { let b = data[pos++]; v = (v << 7) | (b & 0x7f); if (!(b & 0x80)) return v; } }; if (readStr(4) !== "MThd") return; pos += 4; read16(); const tracks = read16(); const div = read16(); for (let i = 0; i < tracks; i++) { if (readStr(4) !== "MTrk") break; let len = read32(), end = pos + len, curTick = 0, rs = null; while (pos < end) { curTick += readVar(); let s = data[pos++]; if (!(s & 0x80)) { s = rs; pos--; } else { rs = s; } const type = s & 0xf0; if (type === 0x80 || type === 0x90) midiEvents.push({ tick: curTick, data: [s, data[pos++], data[pos++]] }); else if (s === 0xFF) { const m = data[pos++], ml = readVar(); if (m === 0x51) tempoMap.push({ tick: curTick, tempo: (data[pos] << 16) | (data[pos+1] << 8) | data[pos+2] }); pos += ml; } else if (type === 0xB0 || type === 0xE0) pos += 2; else if (type === 0xC0 || type === 0xD0) pos += 1; } } tempoMap.sort((a,b) => a.tick - b.tick); midiEvents.sort((a, b) => a.tick - b.tick); let lastT = tempoMap[0], curMs = 0; tempoMap.forEach(tm => { curMs += ((tm.tick - lastT.tick) / div) * (lastT.tempo / 1000); tm.ms = curMs; lastT = tm; }); midiEvents.forEach(ev => { let activeTempo = tempoMap[0]; for(let t of tempoMap) { if(t.tick <= ev.tick) activeTempo = t; else break; } ev.time = activeTempo.ms + ((ev.tick - activeTempo.tick) / div) * (activeTempo.tempo / 1000); }); totalDuration = midiEvents.length > 0 ? midiEvents[midiEvents.length - 1].time : 0; document.getElementById('playbar').max = totalDuration; updateTimeLabel(0); log("File Ready."); notePairs = []; let tempNotes = {}; midiEvents.forEach(ev => { const [status, note, vel] = ev.data; const type = status & 0xF0; if (type === 0x90 && vel > 0) { tempNotes[note] = ev.time; } else if (type === 0x80 || (type === 0x90 && vel === 0)) { if (tempNotes[note] !== undefined) { notePairs.push({ note: note, start: tempNotes[note], end: ev.time }); delete tempNotes[note]; } } }); }
function hslToRgb(h, s, l) { const hue2rgb = (p, q, t) => { if (t < 0) t += 1; if (t > 1) t -= 1; if (t < 1/6) return p + (q - p) * 6 * t; if (t < 1/2) return q; if (t < 2/3) return p + (q - p) * (2/3 - t) * 6; return p; }; const q = l < 0.5 ? l * (1 + s) : l + s - l * s, p = 2 * l - q; return [Math.round(hue2rgb(p, q, h + 1/3) * 255), Math.round(hue2rgb(p, q, h) * 255), Math.round(hue2rgb(p, q, h - 1/3) * 255)]; }
function updateUI() { 
    const vol = document.getElementById('volume');
    document.getElementById('volVal').innerText = vol.value + "%"; 
    if (vol.value == 0) vol.classList.add('is-muted');
    else vol.classList.remove('is-muted');
    document.getElementById('brightVal').innerText = document.getElementById('brightness').value + "%"; 
    document.getElementById('octaveVal').innerText = document.getElementById('octaveShift').value; 
    document.getElementById('transVal').innerText = document.getElementById('transpose').value; 
}
function formatTime(ms) { const s = Math.floor(ms / 1000); return `${Math.floor(s/60)}:${(s%60).toString().padStart(2, '0')}`; }
function updateTimeLabel(ms) { document.getElementById('timeLabel').innerText = `${formatTime(ms)} / ${formatTime(totalDuration)}`; }
function changeSpeed(delta) { playbackRate = Math.min(Math.max(playbackRate + delta, 0.25), 4.0); document.getElementById('speedVal').innerText = playbackRate.toFixed(2) + "x"; if (isPlaying) startTime = performance.now() - (currentTimeOffset / playbackRate); }
function seek(val) { currentTimeOffset = parseFloat(val); nextEventIndex = Math.max(0, midiEvents.findIndex(ev => ev.time >= currentTimeOffset)); updateTimeLabel(currentTimeOffset); if (isPlaying) startTime = performance.now() - (currentTimeOffset / playbackRate); if (learningMode) prepareNextLearningStep(); }
function skip(ms) { seek(Math.min(Math.max(currentTimeOffset + ms, 0), totalDuration)); }
function resetSpeed() { playbackRate = 1.0; document.getElementById('speedVal').innerText = "1.00x"; if (isPlaying) startTime = performance.now() - (currentTimeOffset / playbackRate); }
function toggleRainbow() { rainbow = !rainbow; document.getElementById('btnRainbow').classList.toggle('active', rainbow); }
window.onload = () => { buildKeyboard(); updateUI(); renderFallingNotes(); checkDeckState(); };
</script>
</body>
</html>
