<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Etude - MIDI Light Player</title>
    <link rel="stylesheet" href="etude.css">
</head>
<body>

<div class="rack">

	<div class="header">
        <div class="logo-container">
            <div class="logo">√â T U D E</div>
            <div class="version-tag">v2.0</div>
        </div>
        <div class="header-right-tools">
            <div class="mini-kbd">
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div><div class="m-key b"></div>
                <div class="m-key"></div>
            </div>
            <div id="midiPulse" class="pulse"></div>
        </div>
	</div>
	
    <div class="param-box">
        <span class="static-header">Performance Deck</span>
        <div class="keyboard-panel">
            <div id="scoreContainer" class="score-container">
                <div id="scoreLoading" class="score-loading">
                    <div class="score-loading-spinner"></div>
                    <div>Loading Score...</div>
                </div>
                <div id="osmdContainer"></div>
            </div>
            <div id="vizContainer" class="visualizer-container">
                <canvas id="noteCanvas" width="780" height="300"></canvas>
            </div>
            <div id="piano" class="piano"></div>
        </div>
    </div>

    <div class="param-box">
        <span class="static-header">Main Controls</span>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input type="file" id="midiFile" accept=".mid,.midi" onchange="parseMidiFile(event)">
            <input type="file" id="xmlFile" accept=".xml,.musicxml,.mxl" onchange="parseXMLFile(event)">
            <button onclick="document.getElementById('midiFile').click()" style="flex: 2;" id="fileNameDisplay">Load MIDI File</button>
            <button onclick="openLibraryDialog()" style="flex: 2;" id="xmlFileNameDisplay">Load MusicXML</button>
            <button id="btnToggleViz" onclick="toggleVisualizer()">Notes Off</button>
        </div>

        <div class="controls-row">
            <button id="btnLearn" onclick="toggleLearningMode()" title="Learning Mode">
                <svg viewBox="0 0 24 24"><path d="M12 3L1 9L12 15L21 10.09V17H23V9M5 13.18V17.18L12 21L19 17.18V13.18L12 17L5 13.18Z"/></svg>
            </button>
            <button onclick="seek(0)" >&#x23EE</button>
            <button onclick="skip(-5000)">&#x23F4;&#xfe0e; 5s</button>
            <button class="btn-skip" onclick="changeSpeed(-0.25)">&#x23EA;&#xfe0e;</button>
            <button id="btnPlay" onclick="startPlayback()" style="color: #a3be8c;">‚ñ∂</button>
            <button id="btnPause" onclick="pausePlayback()" style="color: #ebcb8b;">‚è∏</button>
            <button class="btn-skip" onclick="changeSpeed(0.25)" >&#x23E9;&#xfe0e;</button>
            <button onclick="skip(5000)">&#x23F5;&#xfe0e; 5s</button>
            <button onclick="seek(totalDuration)">&#x23ED</button>
        </div>

        <div style="margin-top: 25px;">
            <input type="range" id="playbar" min="0" max="100" value="0" oninput="seek(this.value)">
            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                <span class="speed-indicator" id="speedVal" onclick="resetSpeed()" style="cursor:pointer">1.00x</span>
                <span class="timer-indicator" id="timeLabel">0:00 / 0:00</span>
            </div>
        </div>
        <hr class="divider">
        <div>
            <label>Accent <span class="val" id="volVal">50%</span></label>
            <input type="range" id="volume" min="0" max="100" value="50" oninput="updateUI()">
        </div>
    </div>

    <details class="param-box">
        <summary>System Configuration <span>&#9660;</span></summary>
        <div style="margin-top: 20px;">
            <label>Hardware Connectivity</label>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                <button id="btnSerial" onclick="connectSerial()">Initialize Lighting</button>
                <button id="btnMidi" onclick="connectMidi()">Scan MIDI Devices</button>
                <button id="btnTest" onclick="toggleSystemTest()">Test</button>
            </div>
            <label>Midi Destination <span class="val" id="pianoStatus">Offline</span></label>
            <select id="midiOutSelect" style="margin-bottom: 20px;"><option value="">Select Output Device...</option></select>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <label>Octave <span class="val" id="octaveVal">0</span></label>
                    <input type="range" id="octaveShift" min="-4" max="4" value="0" oninput="updateUI()">
                </div>
                <div>
                    <label>Transpose <span class="val" id="transVal">0</span></label>
                    <input type="range" id="transpose" min="-12" max="12" value="0" oninput="updateUI()">
                </div>
            </div>
            <hr class="divider">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <label>Light Intensity <span class="val" id="brightVal">5%</span></label>
                    <input type="range" id="brightness" min="0" max="100" value="5" oninput="updateUI()">
                </div>
                <div>
                    <label>Master Tint</label>
                    <div style="display:flex; gap:10px; align-items: center;">
						<div style="flex: 1;">
							<label style="margin-bottom: 5px;">White Key LED</label>
							<input type="color" id="whiteKeyColor" class="color-strip" value="#e5c68a" style="width: 100%;" oninput="updateUI()">
						</div>
						<div style="flex: 1;">
							<label style="margin-bottom: 5px;">Black Key LED</label>
							<input type="color" id="blackKeyColor" class="color-strip" value="#917846" style="width: 100%;" oninput="updateUI()">
						</div>
						<button id="btnRainbow" onclick="toggleRainbow()" style="height: 35px; align-self: flex-end;">Rainbow</button>
					</div>
                </div>
            </div>
            <hr class="divider">
            <label>Debug Tools</label>
            <div>
                <button id="btnDebugMeasures" onclick="toggleMeasureDebug()" style="width: auto; display: inline-block;">Show Measure Markers</button>
            </div>
        </div>
    </details>

    <div class="console" id="consoleOut">System Ready.</div>
	<div class="footer-credit">Powered by <span>CORMAL</span></div> 	
	
</div>

<!-- Library Dialog -->
<div id="libraryDialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #1e1e24 0%, #2a2a30 100%); border: 1px solid #444; border-radius: 12px; padding: 35px; max-width: 650px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #444;">
            <h2 style="margin: 0; color: #c2a878; font-size: 24px; font-weight: 300; letter-spacing: 0.5px;">Load MusicXML File</h2>
            <button onclick="closeLibraryDialog()" style="background: transparent; border: 2px solid #c2a878; color: #c2a878; font-size: 20px; cursor: pointer; padding: 0; width: 36px; height: 36px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; line-height: 1; font-weight: bold;" onmouseover="this.style.background='rgba(194, 168, 120, 0.1)'; this.style.transform='rotate(90deg)'" onmouseout="this.style.background='transparent'; this.style.transform='rotate(0deg)'">&times;</button>
        </div>
        
        <div style="margin-bottom: 25px;">
            <button onclick="document.getElementById('xmlFile').click(); closeLibraryDialog();" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #2a2a30 0%, #35353d 100%); color: #d1d1d1; border: 1px solid #444; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='linear-gradient(135deg, #35353d 0%, #3f3f48 100%)'; this.style.borderColor='#c2a878'" onmouseout="this.style.background='linear-gradient(135deg, #2a2a30 0%, #35353d 100%)'; this.style.borderColor='#444'">üìÅ Open from Local Computer</button>
        </div>
        
        <div style="display: flex; align-items: center; margin: 20px 0; color: #444;">
            <div style="flex: 1; height: 1px; background: #444;"></div>
            <span style="padding: 0 15px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #888;">or</span>
            <div style="flex: 1; height: 1px; background: #444;"></div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <h3 style="margin: 0 0 12px 0; color: #c2a878; font-size: 18px; font-weight: 400;">Public Domain Library</h3>
            <div id="libraryStatus" style="color: #c2a878; font-size: 13px; margin-bottom: 12px; padding: 8px 12px; background: rgba(194, 168, 120, 0.1); border-radius: 4px; border-left: 3px solid #c2a878;">Loading library...</div>
            <button id="btnBrowseLibrary" onclick="loadLibraryList()" style="display: none; width: 100%; padding: 12px; background: linear-gradient(135deg, #2a2a30 0%, #35353d 100%); color: #d1d1d1; border: 1px solid #444; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='linear-gradient(135deg, #35353d 0%, #3f3f48 100%)'; this.style.borderColor='#c2a878'" onmouseout="this.style.background='linear-gradient(135deg, #2a2a30 0%, #35353d 100%)'; this.style.borderColor='#444'">üéµ Browse GitHub Library</button>
        </div>
        
        <div id="libraryFileList" style="flex: 1; overflow-y: auto; border: 1px solid #444; border-radius: 6px; padding: 8px; background: rgba(0,0,0,0.2); display: none; min-height: 200px;">
            <!-- Files will be populated here -->
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<script src="./opensheetmusicdisplay.min.js"></script>
<script src="./mxl2midi.js"></script>
<script src="./audio-synth.js"></script>
<script src="./etude.js"></script>
</body>
</html>
